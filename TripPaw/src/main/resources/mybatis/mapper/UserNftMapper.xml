<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssdam.tripPaw.nft.UserNftMapper">

  <!-- 사용자 ID로 NFT 리스트 조회 -->
  <select id="findByUserId" resultType="com.ssdam.tripPaw.domain.UserNft" parameterType="string">
    SELECT * FROM user_nft WHERE member_id = #{userId}
  </select>

  <!-- NFT 삽입 -->
  <insert id="insert" parameterType="com.ssdam.tripPaw.domain.UserNft">
    INSERT INTO user_nft (
      nft_metadata_id, member_id, token_id, wallet_address, barcode,
      due_at, issued_reason, tx_hash, issued_at
    ) VALUES (
      #{nftMetadata.id}, #{member.id}, #{tokenId}, #{walletAddress}, #{barcode},
      #{dueAt}, #{issuedReason}, #{txHash}, NOW()
    )
  </insert>

  <!-- NFT 수정 -->
  <update id="update" parameterType="com.ssdam.tripPaw.domain.UserNft">
    UPDATE user_nft
    SET
      nft_metadata_id = #{nftMetadata.id},
      member_id = #{member.id},
      wallet_address = #{walletAddress},
      barcode = #{barcode},
      due_at = #{dueAt},
      issued_reason = #{issuedReason},
      tx_hash = #{txHash}
    WHERE id = #{id}
  </update>

  <!-- 사용 처리 (used_at 업데이트) -->
  <update id="markAsUsed">
    UPDATE user_nft
    SET used_at = #{usedAt}
    WHERE id = #{id}
  </update>

</mapper>
